/*
 * Copyright 2015 Jason Graves (GodLikeMouse/Collaboradev)
 * http://www.collaboradev.com
 *
 * This file is part of jquery.cube.js.
 *
 * The jquery.cube.js plugin is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation, either
 * version 3 of the License, or (at your option) any later version.
 *
 * The jquery.cube.js plugin is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with the jquery.cube.js plugin. If not, see http://www.gnu.org/licenses/.
 */

$.fn.cube=function(a){function e(a){var b=["U","u","R","r","D","d","L","l","F","f","B","b","M","E","S","X","Y","Z","2","'"];a=a.replace(/\(/gm,"").replace(/\)/gm,"").replace(/\[/gm,"").replace(/\]/gm,"").replace(/\n/gm," "),a=a.replace(/Fw/gm,"f").replace(/Bw/gm,"b").replace(/Rw/gm,"r").replace(/Lw/gm,"l").replace(/Uw/gm,"u").replace(/Dw/gm,"d").replace(/x/gm,"X").replace(/y/gm,"Y").replace(/z/gm,"Z");for(var c=a.split(" "),d=[],e=0;e<c.length;e++){var f=c[e];if(!(0==f.length||f.length>3)){for(var g=!0,h=0;h<f.length;h++){var i=f[h];if($.inArray(i,b)<0){g=!1;break}}if(g){var j=f[1];if($.isNumeric(j))for(f=f.replace(f[1],"");j--;)d.push(f);else d.push(f)}}}return d}function f(b,d){var e=0,f=b.length;$(b).each(function(){var b=$(this),g=b.data("pos");if(d){var h="translate3d("+g.x+"px,"+g.y+"px,"+g.z+"px)",i=0,j=0,k=0;b.animate({rotateX:g.ox,rotateY:g.oy,rotateZ:g.oz},{duration:a.animation.delay,step:function(a,c){switch(c.prop){case"rotateX":i=a;break;case"rotateY":j=a;break;case"rotateZ":k=a}b.css({transform:"rotateX("+i+"deg) rotateY("+j+"deg) rotateZ("+k+"deg) "+h})},complete:function(){b.animate({rotateX:0,rotateY:0,rotateZ:0},0).css({transform:"rotateX(0deg) rotateY(0deg) rotateZ(0deg) "+h}),e++,e==f&&c.trigger("next-move")}})}else b.css({transform:"rotateX("+g.ox+"deg) rotateY("+g.oy+"deg) rotateZ("+g.oz+"deg) translate3d("+g.x+"px,"+g.y+"px,"+g.z+"px)"})})}function g(){var a=c.data("from"),b=c.data("to");if(a&&b){var d=[];$(b).each(function(){d.push({f1:$(this).find(".f1").css("background-color"),f2:$(this).find(".f2").css("background-color"),f3:$(this).find(".f3").css("background-color"),f4:$(this).find(".f4").css("background-color"),f5:$(this).find(".f5").css("background-color"),f6:$(this).find(".f6").css("background-color")})}),$(a).each(function(){var a=d.shift();$(this).find(".f1").css("background-color",a.f1),$(this).find(".f2").css("background-color",a.f2),$(this).find(".f3").css("background-color",a.f3),$(this).find(".f4").css("background-color",a.f4),$(this).find(".f5").css("background-color",a.f5),$(this).find(".f6").css("background-color",a.f6)})}}function h(a,b){switch(a){case"y":switch(b){case 0:return[d[0].get(0),d[1].get(0),d[2].get(0),d[9].get(0),d[10].get(0),d[11].get(0),d[18].get(0),d[19].get(0),d[20].get(0)];case 1:return[d[3].get(0),d[4].get(0),d[5].get(0),d[12].get(0),d[13].get(0),d[14].get(0),d[21].get(0),d[22].get(0),d[23].get(0)];case 2:return[d[6].get(0),d[7].get(0),d[8].get(0),d[15].get(0),d[16].get(0),d[17].get(0),d[24].get(0),d[25].get(0),d[26].get(0)]}case"x":switch(b){case 0:return[d[6].get(0),d[3].get(0),d[0].get(0),d[15].get(0),d[12].get(0),d[9].get(0),d[24].get(0),d[21].get(0),d[18].get(0)];case 1:return[d[7].get(0),d[4].get(0),d[1].get(0),d[16].get(0),d[13].get(0),d[10].get(0),d[25].get(0),d[22].get(0),d[19].get(0)];case 2:return[d[8].get(0),d[5].get(0),d[2].get(0),d[17].get(0),d[14].get(0),d[11].get(0),d[26].get(0),d[23].get(0),d[20].get(0)]}case"z":switch(b){case 0:return[d[6].get(0),d[7].get(0),d[8].get(0),d[3].get(0),d[4].get(0),d[5].get(0),d[0].get(0),d[1].get(0),d[2].get(0)];case 1:return[d[15].get(0),d[16].get(0),d[17].get(0),d[12].get(0),d[13].get(0),d[14].get(0),d[9].get(0),d[10].get(0),d[11].get(0)];case 2:return[d[24].get(0),d[25].get(0),d[26].get(0),d[21].get(0),d[22].get(0),d[23].get(0),d[18].get(0),d[19].get(0),d[20].get(0)]}}}function i(a,b){return"cw"==b?[a[6],a[3],a[0],a[7],a[4],a[1],a[8],a[5],a[2]]:[a[2],a[5],a[8],a[1],a[4],a[7],a[0],a[3],a[6]]}function j(){var a=c.data("from");a&&$(a).each(function(){var a=$(this),b=a.data("pos"),c=a.find(".f1"),d=a.find(".f2"),e=a.find(".f3"),f=a.find(".f4"),g=a.find(".f5"),h=a.find(".f6");switch(b.oy){case-90:var i=c.css("background-color");c.css("background-color",d.css("background-color")),d.css("background-color",e.css("background-color")),e.css("background-color",f.css("background-color")),f.css("background-color",i);break;case 90:var i=f.css("background-color");f.css("background-color",e.css("background-color")),e.css("background-color",d.css("background-color")),d.css("background-color",c.css("background-color")),c.css("background-color",i)}switch(b.ox){case-90:var i=c.css("background-color");c.css("background-color",g.css("background-color")),g.css("background-color",e.css("background-color")),e.css("background-color",h.css("background-color")),h.css("background-color",i);break;case 90:var i=c.css("background-color");c.css("background-color",h.css("background-color")),h.css("background-color",e.css("background-color")),e.css("background-color",g.css("background-color")),g.css("background-color",i)}switch(b.oz){case-90:var i=g.css("background-color");g.css("background-color",d.css("background-color")),d.css("background-color",h.css("background-color")),h.css("background-color",f.css("background-color")),f.css("background-color",i);break;case 90:var i=g.css("background-color");g.css("background-color",f.css("background-color")),f.css("background-color",h.css("background-color")),h.css("background-color",d.css("background-color")),d.css("background-color",i)}b.ox=0,b.oy=0,b.oz=0})}function k(b){var e=$("<div>").addClass("cubit").css({width:a.cubit.width+"px",height:a.cubit.height+"px"});c.append(e);for(var f=0;f<6;f++){var g=$("<div>").addClass("face f"+(f+1)).css({width:a.cubit.width+"px",height:a.cubit.height+"px"});switch(e.append(g),f){case 0:g.css({transform:"translateZ("+a.cubit.width/2+"px)"});break;case 1:g.css({left:a.cubit.width/2+"px",transform:"rotateY(90deg)"});break;case 2:g.css({transform:"translateZ("+-(a.cubit.width/2)+"px) rotateY(180deg)"});break;case 3:g.css({left:-(a.cubit.width/2)+"px",transform:"rotateY(-90deg)"});break;case 4:g.css({top:-(a.cubit.width/2)+"px",transform:"rotateX(90deg)"});break;case 5:g.css({top:a.cubit.width/2+"px",transform:"rotateX(90deg) rotateY(180deg)"})}}return e.data("pos",b),d.push(e),e}function l(){for(var b=0;b<d.length;b++)for(var c=d[b],e=0;e<6;e++)c.find(".f"+(e+1)).css("background-color",a.color[e])}function m(){a.cubit={width:a.size.width/3,height:a.size.height/3};for(var b=-a.cubit.width;b<2*a.cubit.width;b+=a.cubit.width)for(var d=0;d<9;d++){var e={x:0,y:0,z:b,ox:0,oy:0,oz:0};switch(d){case 0:e.x-=a.cubit.width,e.y-=a.cubit.height;break;case 1:e.y-=a.cubit.height;break;case 2:e.x+=a.cubit.width,e.y-=a.cubit.height;break;case 3:e.x-=a.cubit.width;break;case 4:break;case 5:e.x+=a.cubit.width;break;case 6:e.x-=a.cubit.width,e.y+=a.cubit.height;break;case 7:e.y+=a.cubit.height;break;case 8:e.x+=a.cubit.width,e.y+=a.cubit.height}k(e)}f(c.find(".cubit"),!1),l()}var b={position:{x:0,y:0,ox:0,oy:0},size:{width:250,height:250},color:["red","green","orange","blue","yellow","white"],animation:{delay:250}};a=$.extend(b,a);var c=this,d=[];return c.turn=function(a,b){switch(a){case"U":var d=h("y",0),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=-90});break;case"U'":var d=h("y",0),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=90});break;case"u":var g=h("y",0),j=h("y",1),d=g.concat(j),k=i(g,"cw"),l=i(j,"cw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=-90});break;case"u'":var g=h("y",0),j=h("y",1),d=g.concat(j),k=i(g,"ccw"),l=i(j,"ccw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=90});break;case"R":var d=h("x",2),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=90});break;case"R'":var d=h("x",2),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=-90});break;case"r":var g=h("x",2),j=h("x",1),d=g.concat(j),k=i(g,"ccw"),l=i(j,"ccw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=90});break;case"r'":var g=h("x",2),j=h("x",1),d=g.concat(j),k=i(g,"cw"),l=i(j,"cw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=-90});break;case"D":var d=h("y",2),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=90});break;case"D'":var d=h("y",2),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=-90});break;case"d":var g=h("y",2),j=h("y",1),d=g.concat(j),k=i(g,"ccw"),l=i(j,"ccw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=90});break;case"d'":var g=h("y",2),j=h("y",1),d=g.concat(j),k=i(g,"cw"),l=i(j,"cw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=-90});break;case"L":var d=h("x",0),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=-90});break;case"L'":var d=h("x",0),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=90});break;case"l":var g=h("x",0),j=h("x",1),d=g.concat(j),k=i(g,"cw"),l=i(j,"cw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=-90});break;case"l'":var g=h("x",0),j=h("x",1),d=g.concat(j),k=i(g,"ccw"),l=i(j,"ccw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=90});break;case"F":var d=h("z",2),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=90});break;case"F'":var d=h("z",2),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=-90});break;case"f":var g=h("z",2),j=h("z",1),d=g.concat(j),k=i(g,"ccw"),l=i(j,"ccw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=90});break;case"f'":var g=h("z",2),j=h("z",1),d=g.concat(j),k=i(g,"cw"),l=i(j,"cw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=-90});break;case"B":var d=h("z",0),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=-90});break;case"B'":var d=h("z",0),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=90});break;case"b":var g=h("z",0),j=h("z",1),d=g.concat(j),k=i(g,"cw"),l=i(j,"cw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=-90});break;case"b'":var g=h("z",0),j=h("z",1),d=g.concat(j),k=i(g,"ccw"),l=i(j,"ccw"),e=k.concat(l);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=90});break;case"M":var d=h("x",1),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=-90});break;case"M'":var d=h("x",1),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=90});break;case"E":var d=h("y",1),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=-90});break;case"E'":var d=h("y",1),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=90});break;case"S":var d=h("z",1),e=i(d,"ccw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=90});break;case"S'":var d=h("z",1),e=i(d,"cw");c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=-90});break;case"X":var g=h("x",2),j=h("x",1),m=h("x",0),d=g.concat(j).concat(m),k=i(g,"ccw"),l=i(j,"ccw"),n=i(m,"ccw"),e=k.concat(l).concat(n);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=90});break;case"X'":var g=h("x",2),j=h("x",1),m=h("x",0),d=g.concat(j).concat(m),k=i(g,"cw"),l=i(j,"cw"),n=i(m,"cw"),e=k.concat(l).concat(n);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.ox=-90});break;case"Y":var g=h("y",0),j=h("y",1),m=h("y",2),d=g.concat(j).concat(m),k=i(g,"cw"),l=i(j,"cw"),n=i(m,"cw"),e=k.concat(l).concat(n);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=-90});break;case"Y'":var g=h("y",0),j=h("y",1),m=h("y",2),d=g.concat(j).concat(m),k=i(g,"ccw"),l=i(j,"ccw"),n=i(m,"ccw"),e=k.concat(l).concat(n);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oy=90});break;case"Z":var g=h("z",0),j=h("z",1),m=h("z",2),d=g.concat(j).concat(m),k=i(g,"cw"),l=i(j,"cw"),n=i(m,"cw"),e=k.concat(l).concat(n);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=-90});break;case"Z'":var g=h("z",0),j=h("z",1),m=h("z",2),d=g.concat(j).concat(m),k=i(g,"ccw"),l=i(j,"ccw"),n=i(m,"ccw"),e=k.concat(l).concat(n);c.data("from",d),c.data("to",e),$(d).each(function(){var a=$(this).data("pos");a.oz=90});break;default:return}f(d,!0)},c.execute=function(a){a=e(a),console.info(a),c.data("move-stack",a),c.trigger("next-move")},c.on("next-move",function(a){j(),g(),c.data("from",null),c.data("to",null);var b=c.data("move-stack");if(b){console.info("moves",b);var d=b.shift();d||(b=null),c.data("move-stack",b),d&&c.turn(d)}}),c.getOptions=function(){return a},m(),c.data("_cube",c),c}